# 設計書

## フォルダ構成

* amaisbn/ Cypress実行ツールファルダ
* draft/ 原稿フォルダ
	- additional/ 追加感想フォルダ
		- {yyyymmdd}.txt 追加感想履歴ファイル
		- latest.tpac 追加感想最新ファイル
	- master.tpac マスタファイル
	- reviews{yyyy}.txt 感想ファイル
* docs/ 公開フォルダ
	- json/ 公開原稿フォルダ
		- master.json 公開マスタファイル
		- reviews{yyyy}.json 公開感想ファイル
* spec/ 仕様書フォルダ
* src/ ソースコードフォルダ
	- main/ Groovyソースコードフォルダ
	- test/ テストコードフォルダ
	- yakumo/ Yakumoフォルダ
* webpack/ サイト表示スクリプト生成ツールフォルダ

## 機能一覧

* 追加感想最新ファイル生成機能
	- 追加感想履歴ファイルを追加感想最新ファイルに変換します。
* ISBN取得機能
	- 追加感想最新ファイルにISBNを追記します。
* 追加感想最新ファイル反映機能
	- 追加感想最新ファイルを原稿に反映します。
* 公開原稿生成機能
	- 原稿を公開原稿に変換します。
* サイト表示機能
	- 感想をサイトに表示します。

### マスタ下書き生成機能

* pubyearsハンドル
  - 刊行年のリストに不足があれば追記します。
* authorsハンドル
  - 存在しない著者名があればハンドルを追加します。
* tagsハンドル
  - 存在しないタグがあればハンドルを追加します。
* bestsハンドル
  - 存在しないベストがあればハンドルを追加します。

## 画面一覧

* メニュー
	- すべての画面に共通して以下を表示します。
		- 刊行年別一覧画面へのリンク
		- 著者一覧覧画面へのリンク
		- タグ別一覧覧画面へのリンク
		- ベスト別一覧覧画面へのリンク
* トップ画面
	- H1：本サイトについて
	- 本サイトについての説明
* 感想表示画面
	- H1：タイトル
* 刊行年目次画面
	- H1：刊行年
* 刊行年別一覧画面
	- H1：刊行年
	- 目次
	- H2：刊行年月
	- H3：タイトル
* 著者目次画面
* 著者別一覧画面
	- H1：著者名
	- 目次
	- H2：タイトル
* タグ目次画面
* タグ別一覧画面
	- H1：タグ
	- 目次
	- H2：タイトル
* ベスト目次画面
* ベスト別一覧画面
	- H1：ベスト
	- 目次
	- H2：タイトル

## URL一覧

* 全画面に共通表示
    - サイトタイトル
    - 各索引へのリンク
* /
    - ご案内
* /reviews/:reviewID
    - 感想表示画面
* /pubdates
    - 刊行年索引
* /pubdates/:yyyy
    - 刊行年別一覧
* /authors
    - 著者索引
* /authors/:authorID
    - 著者別一覧
* /tags
    - タグ索引
* /tags/:tagID
    - タグ別一覧
* /bests
    - ベスト索引
* /bests/:bestID
    - ベスト別一覧

## ファイル設計

### 追加感想最新ファイル

　以下の宣言並びにハンドルを記述します。

* reviews宣言
	- ハンドル名：刊行年
		- 必須
		- "yyyy"形式
* reviewハンドル
	- reviews宣言の子
	- ハンドル名：略称
		- 必須
		- “★”＋著者名（複数ある場合は半角アンダーバーで連結）＋'|'＋タイトル
		- サイトでは見出しに使用します
		- 先頭の“★”は公開感想から追加分を確認するための目印です
		- タイトルに副題（全角スペース区切り以降）は含めません  
		  半角スペースは半角アンダーバー(_)に置換します

　reviewハンドルには以下のキーを指定します。

* titleキー
	- タイトル
	- 必須
	- サブタイトルは全角スペースで区切ります
* authorsキー
	- 著者
		- 正確には作品の制作に携わったものたちの代表を指します
		- たとえば編者をここに記述することもあります
	- 省略可、複数指定可
		- 省略時は creatorsを指定してください
	- 補足情報は"［編］"のように全角角括弧で囲みます
* creatorsキー
	- その他の作り手（訳者、編者など）
	- 省略可、複数指定可
	- 補足情報は"［編］"のように全角角括弧で囲みます
* publisherキー
	- 版元
	- 必須
* pubdateキー
	- 刊行年月
	- 必須
	- "yyyy年m月"形式
* keywordキー
	- 以下の検索キーワードとして利用します
		- AmazonからISBNを参照
		- 書影をクリックしたときのGoogle検索キーワード
	- 必須
* isbnキー
	- ISBN-13
	- 必須
* bodyキー
	- 本文
	- 必須

### 感想ファイル

　以下の宣言並びにハンドルを記述します。

* reviews宣言
	- ハンドル名：刊行年
		- 必須
		- "yyyy"形式
* pubdate
	- reviews宣言の子
	- ハンドル名：刊行年月
		- 必須
		- "yyyy年m月"形式
* reviewハンドル
	- pubdateハンドルの子
	- ハンドル名：タイトル
		- 必須
		- 追加感想最新ファイルの値を使用します

　reviewハンドルには以下のキーを指定します。
　追加感想最新ファイルから転記するキーは説明を省略しています。

* titleキー
* authorsキー
* creatorsキー
* publisherキー
* pubdateキー
* keywordキー
* isbnキー
* tagsキー
	- タグ名
	- 省略可、複数指定可
* bestsキー
	- ベスト
	- 省略可、複数指定可
	- ベスト名＋半角スペース( )＋ベスト値
	- ベスト値はたとえば"01位"など
* bodyキー
* secretキー
	- ネタバレ
	- 省略可
* noteキー
	- 付記
	- 省略可

### マスタファイル

　以下の宣言、ハンドル、キーを記述します。

* master宣言
* pubyearsハンドル
	- テキスト：刊行年のリスト
		- 必須
		- "yyyy"形式
* authorsハンドル
	* authorハンドル
		- ハンドル名：著者名
			- 必須
			- 感想データのauthorsだけでなく creatorsも含みます。
		* hiraNameキー
			- 著者名のひらがな読み
			- 必須
* tagsハンドル
	* tagハンドル
		- ハンドル名：タグ名
			- 必須
* bestsハンドル
	* bestハンドル
		- ハンドル名：ベスト名
			- 必須

### 公開感想ファイル

　全体がひとつのマップです。

* マップのキーは刊行年月（"yyyymm"形式）です。
  マップの値は、以下のマップです。
	- キーは idキー（後述）の値、
	  値は以下のキーを持つマップです。
		- idキー
			- 刊行年月(yyyymm)＋半角数字２桁の通番
		- titleキー
			- HTML化します
		- abbreキー
			- 略称
			- 半角パイプ(|)を " / "に、半角アンダーバー(_)を半角スペースに置換した上でHTML化します
		- authorsキー
			- 値は以下のキーがあるマップのリストです
				- idキー
					- 著者ID
				- formatキー
					- 著者名を"%s"に置き換えた文字列です
		- creatorsキー
			- 値は以下のキーがあるマップのリストです
				- idキー
					- 著者ID
				- formatキー
					- 著者名を"%s"に置き換えた文字列です
		- publisherキー
		- pubdateキー
			- "yyyymm"形式に置き換えます
		- isbnキー
		- keywordキー
		- tagsキー
			- タグIDのリストに置き換えます
		- bestsキー
			- 値は以下のキーがあるマップのリストです
				- idキー
					- ベストID
				- valueキー
					- ベスト値（"01位"など）
		- bodyキー
			- HTML化します
		- secretキー
			- HTML化します
		- noteキー
			- HTML化します

### 公開マスタファイル

　全体がひとつのマップです。

* pubyearsキー
	- 刊行年（"yyyy"形式）のリスト
* authorsキー
	- 値はマップです
	  マップのキーはid、値は以下のキーがあるマップです
		- idキー
			- 半角数字４桁の通番
		- nameキー
			- 著者名
		- hiraNameキー
		- reviewsキー
			- reviewIDのリスト
* tagsキー
	- 値はマップです
	  マップのキーはid、値は以下のキーがあるマップです
		- id
			- 半角数字４桁の通番
		- nameキー
			- タグ名
		- reviewsキー
			- reviewIDのリスト
* bestsキー
	- 値はマップです
	  マップのキーはid、値は以下のキーがあるマップです
		- id
			- 半角数字４桁の通番
		- nameキー
			- ベスト名
		- reviewsキー
			- reviewIDのリスト
