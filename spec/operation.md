# 運用手順書

## 環境構築

　あらかじめ npmと gradleがインストールされている必要があります。

```
$ npm --version
9.8.1

$ gradle --version

------------------------------------------------------------
Gradle 7.4
------------------------------------------------------------

Build time:   2022-02-08 09:58:38 UTC
Revision:     f0d9291c04b90b59445041eaa75b2ee744162586

Kotlin:       1.5.31
Groovy:       3.0.9
Ant:          Apache Ant(TM) version 1.10.11 compiled on July 10 2021
JVM:          1.8.0_322 (ojdkbuild 25.322-b06)
OS:           Windows 10 10.0 amd64
```

　本リポジトリをローカルにクローンした後、以下を実行してください。

* ISBN取得ツールの準備
* サイト表示スクリプト生成ツールの準備

　ローカルでのサイト表示の確認は別途 Webサーバを用意してください。  
　Webサーバはたとえば [logipa](https://github.com/longfish801/logipa) などを利用してください。

## 事前準備

　本ツールの利用前に以下を実行してください。

```
# 事前準備を実行する
gradle setup
```

　上記のコマンドは以下のコマンド実行に相当します。

```
# ISBN取得ツールに必要なパッケージをインストールします
cd amaisbn
npm install
# サイト表示スクリプト生成ツールに必要なパッケージをインストールします
cd ../webpack
npm install
# サイト表示スクリプトを出力します
# docs/script.jsに出力します
npm run build
```

## 感想の追加

　感想を追加するための作業の流れは以下のとおりです。

1. 感想履歴ファイルを作成します。
2. 感想履歴ファイルから追加感想ファイルを生成します。
3. 追加感想ファイルを原稿に反映します。
4. 原稿ファイルから公開原稿ファイルを生成します。
5. ローカルのWebサーバでサイト表示を確認します。
6. 公開します。

　新しく感想履歴ファイルを作成し、テキスト形式で感想を記述します。  
　これをtpac形式に変換して追加感想ファイルを生成します。

　追加感想ファイルにISBNを追加します。  
　エディタで開いて種々の編集をします。

　既存の感想すべてとマスタを tpac形式で保持しているのが原稿です。  
　追加感想ファイルの内容を原稿に反映します。

　サイト上で公開している感想はJSON形式で保持しています。  
　原稿を公開原稿へ変換します。

　最後にGitコマンドを用いてリモートリポジトリに反映することで公開されます。

### 感想履歴ファイルの作成

　感想データの原本ファイルを作成してください。

　下書きフォルダにシステム日付でテキストファイルを作成してください。  
　フォーマットは {yyyymmdd}.txtです。

　感想が複数行あるときは、行を逆順に並べてください。  
　各感想の一行目はたとえば以下の形式としてください。

```
山田太郎『大傑作』（出帆社／2013年4月）読了。
```

　たとえば著者が複数、サブタイトルあり、訳者ありならば以下の形式です。

```
山田一人、山田二人『大傑作　これぞ名作だ』（薬師次郎［訳］／出帆社／2013年4月）読了。
```

　詳細は以下のとおりです。

* “『”の前に著者名を記述します。
	- 著者が複数いる場合は半角スペースあるいは“、”で区切ります。
* “『”と“』”の間にタイトルを記述します。
	- 巻数がある場合はタイトルの直後に半角スペース区切り、あるいは区切り文字無しで記述してください。
	- サブタイトルがある場合は全角スペースで区切ってください。
* その他の書誌情報を“（”と“）”の間に“／”区切りで記述してください。
	- 終わりから二番目に版元あるいはレーベル名を記述してください。
	- 必ず最後に刊行年月（フォーマットは {yyyy}年{m}月）を記述してください。
	- 訳者を記述する場合は名前の前あるいは後ろに“［訳］”あるいは半角スペースを空けて“訳”と記述してください。  
	  編者なども同様にしてください。

### 感想履歴ファイルから追加感想ファイルを生成

　感想履歴ファイルを追加感想ファイルに変換します。
　このときハンドル名の先頭に“★”を付与します。

```
# 追加感想ファイルに変換する
gradle latest
```

　感想の対象となる本のISBNを取得します。  
　以下を実行してください。  
　感想データからキーワードを生成します。  
　そのキーワードで Amazonを検索し、商品ページからISBNを取得します。  
　latest.tpacファイルに ISBNを追記します。  
　またamaisbn/conver.htmlを出力します。  
　ブラウザで開いて書影が適切か確認してください。

```
# ISBNを調べます
gradle isbn
```

　追加感想ファイル latest.tpacファイルをエディタで開いてください。  
　必要に応じて編集してください。  
　たとえば以下に留意してください。

* titleキー
    - ルビをふっていること
    - 逆に review, keywordキーにはルビをふらないでください
* authors, creatorsキー
    - 補足情報（編者の"［編］"など）が適切であること
* bodyキー
    - 推敲、改行位置の見直し
* 必要に応じて以下のキーを追加してください
    - tagsキー
    - secretキー
    - noteキー

　ISBNの取得に失敗することもあるため、以下を確認してください。  
　失敗している場合は手動で補ってください。

* amaisbn/cypress/screenshotsに、ISBNの取得に失敗したときのキャプチャ画像が出力されていないこと。
* ISBNが感想と同じ個数分だけ挿入されていること。

### 追加感想ファイルを原稿に反映

　追加感想ファイルを原稿に反映します。  
　原稿とは感想ファイル、マスタファイルのことを指します。

```
# 追加感想ファイルを原稿に反映します
gradle merge
```

　原稿(./draft/*.tpac)を“★”で検索してください。  
　感想について記述に問題なければハンドル名の先頭から“★”を削除してください。

　マスタファイルについて、以下の編集をしてください。

* authors / author / hiraName
	* 新たに追加した著者名についてルビを正しく取得できているか確認してください。  
	  取得に失敗している場合は正しいルビに修正してください。
* categories / category:★未整理
	* 新たなタグはすべて「★未整理」ハンドルに分類されます。  
	  適切なカテゴリに移動してください。  
	  その後「★未整理」ハンドルは削除してください。

### 原稿ファイルから公開原稿ファイルを生成

　原稿ファイルから公開原稿ファイルを生成します。  
　公開原稿はjson形式のファイルです。

```
# 原稿を公開原稿に変換する
gradle public
```

　作業完了後は不要な中間生成ファイルを削除してください。

```
# 中間生成ファイルを削除する
gradle clean
```

### ローカルのWebサーバでサイト表示を確認

　Webサーバを起動してください。  
　ブラウザで [http://localhost/readnow/](http://localhost/readnow/) を開き、追加した感想について表示に問題がないか確認してください。  

　なお webpackの Webサーバを利用する場合は以下を実行してください。  
　こちらの場合は [http://localhost:8080/readnow/](http://localhost:8080/readnow/) を開いてください。  

```
# 動作を確認する
cd webpack
npm run start
```

ビルド時にwebpack/package.jsonを以下のとおり修正するとwebpackについて開発環境向けの設定を用いることになり、コンソールでのエラー内容がわかりやすくなります。  
デバッグが終わったならば本番環境向けの設定に戻してください。

```
{
	...
	"scripts": {
		...
		"build": "webpack --config webpack.prod.js"
		  ↓修正
		"build": "webpack --config webpack.dev.js"
```

### 公開

　Gitコマンドを用いてリモートリポジトリに反映してください。

## 感想の修正/削除

　追加した感想を修正、削除したい場合は以下を実行してください。

1. 原稿を修正あるいは削除します。
2. 原稿を公開原稿に変換します。
3. 公開します。

## 改修後のテスト

　src/main配下の Groovyソースコードを改修したときは、以下のコマンドでテストを実行してください。  
　すべてのテストが成功することを確認してください。

```
# Groovyソースコードをテストする
gradle clean test
```

　Groovyソースコードや webpack配下を改修したときは、以下のコマンドで E2Eテストを実行してください。  
　事前に Webサーバを起動しておいてください。

```
# E2Eテストを実行する
gradle clean e2e
```

　上記のコマンドを実行すると E2Eテスト用の原稿を公開原稿に変換します。  
　このため `gradle public` コマンドを実行して本来の原稿に基づく公開原稿を再作成する必要があることにご注意ください。
